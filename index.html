<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.css">
  <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/jquery.ui/1.13.2/themes/black-tie/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.js"></script>
  <!--    registros_kvk_inicial-->
  <script src="registroInicial.js"></script>
  <script src="registroActual.js"></script>

  <script>
    var reinos = [1206,1381,1869,1948,2026,2042,2043,2139]
    var resumen_reinos_inicial = []
    var resumen_reinos_actual = []
    var resumen_reinos_progreso = []
    var registrosMap = {
      1206:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      1381:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      1869:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      1948:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      2026:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      2042:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      2043:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      },
      2139:{
        inicial:{stats:{}, detalle:[]},
        actual:{stats:{}, detalle:[]}
      }
    }
    var resumir_registros = function(regitros, reino){
      let count = {
        reino: reino,
        poder:0,
        muertos:0,
        killPoints:0,
        jugadoresBajo55:0,
        jugadoresEntre55y75:0,
        jugadoresEntre75y100:0,
        jugadoresSobre100:0,
        kpBajo500M:0,
        kpEntre500My1B:0,
        kpEntre1By2B:0,
        kpSobre2B:0
      }
      regitros.forEach(function(registro){
        count.poder+=registro.poder;
        count.muertos+=registro.tropas_muertas;
        count.killPoints+=registro.puntos_muerte;
        count.jugadoresBajo55+=registro.poder<55000000?1:0;
        count.jugadoresEntre55y75+=verificaIntervalo(55000000, 75000000,registro.poder)?1:0;
        count.jugadoresEntre75y100+=verificaIntervalo(75000000, 100000000, registro.poder)?1:0;
        count.jugadoresSobre100+=registro.poder>100000000?1:0;
        count.kpBajo500M+=registro.puntos_muerte<55000000?1:0;
        count.kpEntre500My1B+=verificaIntervalo(55000000, 75000000, registro.puntos_muerte)?1:0;
        count.kpEntre1By2B+=verificaIntervalo(75000000, 100000000, registro.puntos_muerte)?1:0;
        count.kpSobre2B+=registro.puntos_muerte>100000000?1:0;
      })
      return count;
    }
    var verificaIntervalo = function (valorMin, valorMax, valor){
      return valor>=valorMin && valor<valorMax
    }
    function textoPositivoNegativo(valor){
      return valor>=0?'+'+valor:valor;
    }
    function calculaProgresoResumen(resumenInicial, resumenActual) {
      return {
        reino: resumenInicial.reino,
        poder: textoPositivoNegativo(resumenActual.poder-resumenInicial.poder),
        muertos: textoPositivoNegativo(resumenActual.muertos-resumenInicial.muertos),
        killPoints: textoPositivoNegativo(resumenActual.killPoints-resumenInicial.killPoints),
        jugadoresBajo55: textoPositivoNegativo(resumenActual.jugadoresBajo55-resumenInicial.jugadoresBajo55),
        jugadoresEntre55y75: textoPositivoNegativo(resumenActual.jugadoresEntre55y75-resumenInicial.jugadoresEntre55y75),
        jugadoresEntre75y100: textoPositivoNegativo(resumenActual.jugadoresEntre75y100-resumenInicial.jugadoresEntre75y100),
        jugadoresSobre100: textoPositivoNegativo(resumenActual.jugadoresSobre100-resumenInicial.jugadoresSobre100),
        kpBajo500M: textoPositivoNegativo(resumenActual.kpBajo500M-resumenInicial.kpBajo500M),
        kpEntre500My1B: textoPositivoNegativo(resumenActual.kpEntre500My1B-resumenInicial.kpEntre500My1B),
        kpEntre1By2B: textoPositivoNegativo(resumenActual.kpEntre1By2B-resumenInicial.kpEntre1By2B),
        kpSobre2B: textoPositivoNegativo(resumenActual.kpSobre2B-resumenInicial.kpSobre2B)
      };
    }

    var iniciarListas = function (){
      reinos.forEach(function(reino){
        let registros_reino_inicial = registros_kvk_inicial.filter(function(registro){
          return registro.reino == reino;
        });
        let registros_reino_actual = registros_kvk_actual.filter(function(registro){
          return registro.reino == reino;
        });
        registrosMap[reino].inicial.detalle = registros_reino_inicial;
        registrosMap[reino].actual.detalle = registros_reino_actual;
        let resumenInicial = resumir_registros(registros_reino_inicial, reino);
        let resumenActual = resumir_registros(registros_reino_actual, reino);
        resumen_reinos_inicial.push(resumenInicial)
        resumen_reinos_actual.push(resumenActual)
        resumen_reinos_progreso.push(calculaProgresoResumen(resumenInicial, resumenActual))
      })
    }
    var iniciarTablas = function (){
      $('#tabla-resumen-inicial').DataTable({
        paging: false,
        data: resumen_reinos_inicial,
        columns: [
          { title: 'Reino', data:'reino' },
          { title: 'Poder', data:'poder' },
          { title: 'Muertos', data:'muertos' },
          { title: 'Puntos de muerte', data:'killPoints' },
          { title: 'Poder<55M', data:'jugadoresBajo55' },
          { title: 'Poder 55M-75M', data:'jugadoresEntre55y75' },
          { title: 'Poder 75M-100M', data:'jugadoresEntre75y100' },
          { title: 'Poder>100M', data:'jugadoresSobre100' },
          { title: 'KP<500M', data:'kpBajo500M' },
          { title: 'KP 500M-1B', data:'kpEntre500My1B' },
          { title: 'KP 1B-2B', data:'kpEntre1By2B' },
          { title: 'KP>2B', data:'kpSobre2B' },
        ],
      });
      $('#tabla-resumen-actual').DataTable({
        paging: false,
        data: resumen_reinos_actual,
        columns: [
          { title: 'Reino', data:'reino' },
          { title: 'Poder', data:'poder' },
          { title: 'Muertos', data:'muertos' },
          { title: 'Puntos de muerte', data:'killPoints' },
          { title: 'Poder<55M', data:'jugadoresBajo55' },
          { title: 'Poder 55M-75M', data:'jugadoresEntre55y75' },
          { title: 'Poder 75M-100M', data:'jugadoresEntre75y100' },
          { title: 'Poder>100M', data:'jugadoresSobre100' },
          { title: 'KP<500M', data:'kpBajo500M' },
          { title: 'KP 500M-1B', data:'kpEntre500My1B' },
          { title: 'KP 1B-2B', data:'kpEntre1By2B' },
          { title: 'KP>2B', data:'kpSobre2B' },
        ],
      });
      $('#tabla-resumen-progreso').DataTable({
        paging: false,
        data: resumen_reinos_progreso,
        columns: [
          { title: 'Reino', data:'reino' },
          { title: 'Poder', data:'poder' },
          { title: 'Muertos', data:'muertos' },
          { title: 'Puntos de muerte', data:'killPoints' },
          { title: 'Poder<55M', data:'jugadoresBajo55' },
          { title: 'Poder 55M-75M', data:'jugadoresEntre55y75' },
          { title: 'Poder 75M-100M', data:'jugadoresEntre75y100' },
          { title: 'Poder>100M', data:'jugadoresSobre100' },
          { title: 'KP<500M', data:'kpBajo500M' },
          { title: 'KP 500M-1B', data:'kpEntre500My1B' },
          { title: 'KP 1B-2B', data:'kpEntre1By2B' },
          { title: 'KP>2B', data:'kpSobre2B' },
        ],
      });
      reinos.forEach(function(reino){
        $('#tabla-detalle-'+reino+'-inicial').DataTable({
          paging: false,
          data: registrosMap[reino].inicial.detalle,
          columns: [
            { title: 'id', data:'id_jugador' },
            { title: 'Nombre', data:'nombre' },
            { title: 'Poder', data:'poder' },
            { title: 'Muertos', data:'tropas_muertas' },
            { title: 'Puntos de muerte', data:'puntos_muerte' },
            { title: 'fecha', data:'fecha' },
          ],
        });
        $('#tabla-detalle-'+reino+'-actual').DataTable({
          paging: false,
          data: registrosMap[reino].actual.detalle,
          columns: [
            { title: 'id', data:'id_jugador' },
            { title: 'Nombre', data:'nombre' },
            { title: 'Poder', data:'poder' },
            { title: 'Muertos', data:'tropas_muertas' },
            { title: 'Puntos de muerte', data:'puntos_muerte' },
            { title: 'fecha', data:'fecha' },
          ],
        });
      })
    }
    var iniciarTabs =  function (){
      var tabs = $( ".tabs" ).tabs();
      var previouslyFocused = false;

      tabs.find( ".ui-tabs-nav" ).sortable({
        axis: "x",

        // Sortable removes focus, so we need to restore it if the tab was focused
        // prior to sorting
        start: function(event, ui) {
          previouslyFocused = document.activeElement === ui.item[ 0 ];
        },
        stop: function(event, ui) {
          tabs.tabs( "refresh" );
          if (previouslyFocused) {
            ui.item.trigger( "focus" );
          }
        }
      });
    }
    var crearHtmlTabsDetalle = function (){
      let listaReinos = $("#lista-reinos")
      let tabDetalles = $("#tabs-detalles")
      reinos.forEach(function(reino){
        listaReinos.append('<li><a href="#tabs-'+reino+'">'+reino+'</a></li>')
        tabDetalles.append('<div id="tabs-'+reino+'">' +
                '<div class="tabs">' +
                '<ul>' +
                '<li><a href="#tabs-'+reino+'-inicial">Detalle inicial</a></li>' +
                '<li><a href="#tabs-'+reino+'-actual">Detalle actual</a></li>' +
                '</ul>' +
                '<div id="tabs-'+reino+'-inicial">' +
                '<table id="tabla-detalle-'+reino+'-inicial" class="display"></table>' +
                '</div>' +
                '<div id="tabs-'+reino+'-actual">' +
                '<table id="tabla-detalle-'+reino+'-actual" class="display"></table>' +
                '</div>' +
                '</div>' +

                '</div>')
      })
    }
    $(document).ready( function () {
      iniciarListas();
      crearHtmlTabsDetalle();
      iniciarTablas();
      iniciarTabs();
    } );
  </script>

</head>
<body>

<h1>Resumenes</h1>
<div class = "tabs">
  <ul>
    <li><a href="#tabs-resumen-inicial">Resumen inicial</a></li>
    <li><a href="#tabs-resumen-actual">Resumen actual</a></li>
    <li><a href="#tabs-resumen-progreso">Progreso</a></li>
  </ul>
  <div id="tabs-resumen-inicial">
    <table id="tabla-resumen-inicial" class="display"></table>
  </div>
  <div id="tabs-resumen-actual">
    <table id="tabla-resumen-actual" class="display"></table>
  </div>
  <div id="tabs-resumen-progreso">
    <table id="tabla-resumen-progreso" class="display"></table>
  </div>
</div>
<h1>Detalle por reino</h1>
<div class="tabs" id="tabs-detalles">
  <ul id="lista-reinos">
  </ul>

</div>
</body>
</html>